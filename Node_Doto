// å¼•å…¥ Node.js å†…ç½®æ¨¡å—
const fs = require('fs');       // æ–‡ä»¶æ“ä½œæ¨¡å—
const path = require('path');   // è·¯å¾„å¤„ç†æ¨¡å—
const readline = require('readline'); // å‘½ä»¤è¡Œäº¤äº’æ¨¡å—

// å®šä¹‰ä»»åŠ¡æ•°æ®å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„ï¼ˆå­˜ä¸º JSON æ ¼å¼ï¼‰
const tasksPath = path.join(__dirname, 'tasks.json');

// åˆå§‹åŒ–ä»»åŠ¡æ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºæ•°ç»„ï¼‰
function initTasksFile() {
  if (!fs.existsSync(tasksPath)) {
    fs.writeFileSync(tasksPath, '[]', 'utf8');
  }
}

// è¯»å–æ‰€æœ‰ä»»åŠ¡
function getTasks() {
  initTasksFile(); // ç¡®ä¿æ–‡ä»¶å­˜åœ¨
  const data = fs.readFileSync(tasksPath, 'utf8');
  return JSON.parse(data); // è§£æ JSON ä¸ºæ•°ç»„
}

// ä¿å­˜ä»»åŠ¡åˆ°æ–‡ä»¶
function saveTasks(tasks) {
  fs.writeFileSync(tasksPath, JSON.stringify(tasks, null, 2), 'utf8');
}

// 1. æ·»åŠ ä»»åŠ¡
function addTask(content) {
  const tasks = getTasks();
  // ç”Ÿæˆå”¯ä¸€ IDï¼ˆç”¨æ—¶é—´æˆ³ç®€åŒ–å®ç°ï¼‰
  const newTask = {
    id: Date.now().toString(), // æ—¶é—´æˆ³ä½œä¸º ID
    content: content,          // ä»»åŠ¡å†…å®¹
    completed: false,          // çŠ¶æ€ï¼šæœªå®Œæˆ
    createdAt: new Date().toLocaleString() // åˆ›å»ºæ—¶é—´
  };
  tasks.push(newTask);
  saveTasks(tasks);
  console.log(`âœ… ä»»åŠ¡æ·»åŠ æˆåŠŸï¼ID: ${newTask.id}`);
}

// 2. æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
function listTasks() {
  const tasks = getTasks();
  if (tasks.length === 0) {
    console.log('ğŸ“‹ æš‚æ— ä»»åŠ¡ï¼Œå¿«å»æ·»åŠ å§ï¼');
    return;
  }
  console.log('\nğŸ“ æ‰€æœ‰ä»»åŠ¡ï¼š');
  tasks.forEach(task => {
    // ç”¨ emoji åŒºåˆ†çŠ¶æ€
    const status = task.completed ? 'âœ…' : 'âŒ';
    console.log(`
ID: ${task.id}
å†…å®¹ï¼š${task.content}
çŠ¶æ€ï¼š${status}ï¼ˆ${task.completed ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ'}ï¼‰
åˆ›å»ºæ—¶é—´ï¼š${task.createdAt}
    `);
  });
}

// 3. æ ‡è®°ä»»åŠ¡ä¸ºå·²å®Œæˆ
function completeTask(taskId) {
  const tasks = getTasks();
  const task = tasks.find(t => t.id === taskId);
  if (!task) {
    console.log('âŒ æœªæ‰¾åˆ°è¯¥ä»»åŠ¡ï¼Œè¯·æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®ï¼');
    return;
  }
  task.completed = true;
  saveTasks(tasks);
  console.log(`âœ… ä»»åŠ¡ ID: ${taskId} å·²æ ‡è®°ä¸ºå®Œæˆï¼`);
}

// 4. åˆ é™¤ä»»åŠ¡
function deleteTask(taskId) {
  let tasks = getTasks();
  const initialLength = tasks.length;
  tasks = tasks.filter(t => t.id !== taskId); // è¿‡æ»¤æ‰è¦åˆ é™¤çš„ä»»åŠ¡
  if (tasks.length === initialLength) {
    console.log('âŒ æœªæ‰¾åˆ°è¯¥ä»»åŠ¡ï¼Œè¯·æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®ï¼');
    return;
  }
  saveTasks(tasks);
  console.log(`ğŸ—‘ï¸ ä»»åŠ¡ ID: ${taskId} å·²åˆ é™¤ï¼`);
}

// 5. æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡
function clearAllTasks() {
  saveTasks([]);
  console.log('ğŸ§¹ æ‰€æœ‰ä»»åŠ¡å·²æ¸…ç©ºï¼');
}

// å‘½ä»¤è¡Œäº¤äº’é€»è¾‘
function start() {
  console.log('\n===== ä»»åŠ¡ç®¡ç†å·¥å…· =====');
  console.log('è¯·é€‰æ‹©æ“ä½œï¼š');
  console.log('1. æ·»åŠ ä»»åŠ¡');
  console.log('2. æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡');
  console.log('3. æ ‡è®°ä»»åŠ¡ä¸ºå®Œæˆ');
  console.log('4. åˆ é™¤ä»»åŠ¡');
  console.log('5. æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡');
  console.log('6. é€€å‡º');

  // åˆ›å»ºå‘½ä»¤è¡Œäº¤äº’æ¥å£
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });

  // è·å–ç”¨æˆ·è¾“å…¥çš„æ“ä½œç¼–å·
  rl.question('è¯·è¾“å…¥æ“ä½œç¼–å·ï¼ˆ1-6ï¼‰ï¼š', (choice) => {
    switch (choice) {
      case '1':
        rl.question('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹ï¼š', (content) => {
          addTask(content);
          rl.close();
          start(); // å®Œæˆåé‡æ–°æ˜¾ç¤ºèœå•
        });
        break;
      case '2':
        listTasks();
        rl.close();
        start();
        break;
      case '3':
        rl.question('è¯·è¾“å…¥è¦æ ‡è®°å®Œæˆçš„ä»»åŠ¡ IDï¼š', (id) => {
          completeTask(id);
          rl.close();
          start();
        });
        break;
      case '4':
        rl.question('è¯·è¾“å…¥è¦åˆ é™¤çš„ä»»åŠ¡ IDï¼š', (id) => {
          deleteTask(id);
          rl.close();
          start();
        });
        break;
      case '5':
        rl.question('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿ(y/n)ï¼š', (answer) => {
          if (answer.toLowerCase() === 'y') {
            clearAllTasks();
          } else {
            console.log('å·²å–æ¶ˆæ¸…ç©ºæ“ä½œ');
          }
          rl.close();
          start();
        });
        break;
      case '6':
        console.log('ğŸ‘‹ å†è§ï¼');
        rl.close();
        break;
      default:
        console.log('âŒ æ— æ•ˆçš„æ“ä½œï¼Œè¯·è¾“å…¥ 1-6 ä¹‹é—´çš„æ•°å­—ï¼');
        rl.close();
        start();
    }
  });
}

// å¯åŠ¨ç¨‹åº
start();
